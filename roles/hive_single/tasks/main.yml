- name: Fail if not Ubuntu 24.04
  ansible.builtin.assert:
    that:
      - ansible_facts['distribution'] == 'Ubuntu'
      - ansible_facts['distribution_version'] == '24.04'
      - ansible_facts['pkg_mgr'] == 'apt'
    fail_msg: >
      Role hive_single supports Ubuntu 24.04 only.
      Detected: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
      (pkg_mgr={{ ansible_facts['pkg_mgr'] }}).

- name: Install PostgreSQL (metastore) + psycopg2
  ansible.builtin.apt:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: true

- name: Ensure PostgreSQL running
  ansible.builtin.systemd:
    name: postgresql
    enabled: true
    state: started


- name: Set listen_addresses to '*'
  ansible.builtin.lineinfile:
    path: /etc/postgresql/16/main/postgresql.conf
    regexp: '^#?listen_addresses'
    line: "listen_addresses = '*'"
    state: present

- name: Allow Hive Metastore access in pg_hba.conf
  lineinfile:
    path: /etc/postgresql/16/main/pg_hba.conf
    line: "host   metastore   hive   {{ ansible_host }}/32   md5"
    regexp: '^host\s+metastore\s+hive\s+{{ ansible_host }}\/32\s+md5$'
    state: present
    insertafter: EOF

- name: Always restart postgresql after pg_hba.conf update
  ansible.builtin.systemd:
    name: postgresql
    state: restarted

- name: Create metastore user
  community.postgresql.postgresql_user:
    name: "{{ metastore_user }}"
    password: "{{ metastore_password }}"
  become_user: postgres

- name: Create metastore db
  community.postgresql.postgresql_db:
    name: "{{ metastore_db }}"
    owner: "{{ metastore_user }}"
  become_user: postgres

- name: Ensure public schema owner is metastore_user
  community.postgresql.postgresql_query:
    db: "{{ metastore_db }}"
    query: "ALTER SCHEMA public OWNER TO {{ metastore_user }};"
  become_user: postgres

- name: Install Hive packages
  ansible.builtin.apt:
    name: "{{ hive_packages }}"
    state: present

- name: Deploy hive-site.xml
  ansible.builtin.template:
    src: hive-site.xml.j2
    dest: "{{ hive_conf_dir }}/hive-site.xml"
    mode: "0644"
  notify: restart hive

- name: Create HDFS warehouse dir
  become_user: "{{ hadoop_user }}"
  ansible.builtin.shell: |
    set -euo pipefail
    hdfs dfs -test -d {{ hive_warehouse_dir }} || hdfs dfs -mkdir -p {{ hive_warehouse_dir }}
    hdfs dfs -chown -R {{ hive_user }}:{{ hive_group }} {{ hive_dir }}
    hdfs dfs -chmod 771 {{ hive_dir }}
    hdfs dfs -chmod 771 {{ hive_warehouse_dir }}
    hdfs dfs -test -d {{ tmp_dir }} || hdfs dfs -mkdir -p {{ tmp_dir }}
    hdfs dfs -chmod -R 1777 {{ tmp_dir }}
  args:
    executable: /bin/bash
  changed_when: false

- name: Install PostgreSQL JDBC driver
  ansible.builtin.apt:
    name: libpostgresql-jdbc-java
    state: present

- name: Symlink postgresql.jar into Hive lib
  ansible.builtin.file:
    src: /usr/share/java/postgresql.jar
    dest: "{{ hive_home }}/lib/postgresql.jar"
    state: link
    force: true

- name: Remove old postgresql jar (if exists)
  ansible.builtin.file:
    path: "{{ hive_home }}/lib/postgresql-9.4.1208.jre7.jar"
    state: absent

- name: Init hive metastore schema (only once)
  become_user: "{{ hadoop_user }}"
  ansible.builtin.command: "/usr/lib/hive/bin/schematool -dbType postgres -initSchema"
  args:
    creates: "/var/lib/hive/.schema_inited"
  register: schematool_result
  failed_when: schematool_result.rc != 0 and 'already exists' not in schematool_result.stderr

- name: Create schema init marker
  ansible.builtin.file:
    path: /var/lib/hive/.schema_inited
    state: touch
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: "0644"
  when: schematool_result is not skipped and (schematool_result.rc == 0 or 'already exists' in schematool_result.stderr)

- name: Write /etc/default/hive
  ansible.builtin.copy:
    dest: /etc/default/hive
    mode: "0644"
    content: |
      HIVE_HOME=/usr/lib/hive
      HIVE_CONF_DIR=/etc/hive/conf
      HADOOP_CONF_DIR=/etc/hadoop/conf
      YARN_CONF_DIR=/etc/hadoop/conf
      MAPRED_CONF_DIR=/etc/hadoop/conf
      JAVA_HOME={{ java_home }}
      TERM=dumb
  notify: restart hive

- name: Install systemd units (Hive)
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    mode: "0644"
  loop:
    - hive-metastore.service
    - hiveserver2.service
  notify: systemd daemon-reload

- name: systemd daemon-reload now
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable & start Hive services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - hive-metastore
    - hiveserver2

- name: Ensure HDFS /tmp is world-writable
  become: true
  become_user: hadoop
  ansible.builtin.command: hdfs dfs -chmod -R 1777 /tmp
